---
title: "Random_walk"
author: "Tempest McCabe"
date: "7/2/2019"
output: html_document
---


```{r}

library(rjags)

# load data
points_of_less_than_six_big <- which(tick_disease_big == "<6")
points_of_less_than_six <- which(tick_disease_big == "<6")


## use non cumberland, non less than six, non 2001-2008 data
tick_disease_big_tmp <- tick_disease_big[tick_disease_big$Number != "<6",]
tick_disease_big_tmp <- tick_disease_big_tmp[!(tick_disease_big_tmp$Location %in% towns_in_cumberland),]
tick_disease_other <- dplyr::filter(tick_disease_big_tmp, tick_disease_big_tmp$Year > 2008)

# estimate the probability that results in a disease status with other population data
get_tick_disease_probability <- "model{
## process model
  for (i in 1:n){
   number_of_disease_risk[i] <- dbiom(pop[i], probability)
  }

## Prior
probability <- dbeta(1,1) # uniform probability
}
"

data <- list(n = length(tick_disease_other$Number),  number_of_disease_risk = as.numeric(tick_disease_other$Number), pop = tick_disease_other$Population)
  
nchain = 3
init <- list()
for(i in 1:nchain){
  init[[i]] <- list(m = 0.5, D_0 = 0.016, min_conductance = 0.001)
}


j.model   <- jags.model (file = textConnection(get_tick_disease_probability),
                             data = data,
                             inits = init,
                             n.chains = 3)

jags.out   <- coda.samples (model = j.model,
                            variable.names = c("probability"),
                                n.iter = n.iter)


### Fit actual random walk
random_walk = "
model{
  
    D_0_corrected <- D_0 + 0.000001 # To avoid deviding by zero issues
  for (i in 1:num_points){
    #### Process Model
    X[i] <- A[i]/(Ca[i]*(1+(vpd[i]/D_0_corrected)))
    mu[i] <- min_conductance + m*X[i]
    gs[i] ~ dnorm(mu[i], precision)
  }
  
  
  #### Priors
  D_0 ~ dgamma(1.19999, 90) # from ED2 default (0.016), and conversation with Mike (max)
  m ~ dnorm(stomatal_slope_average, 1/stomatal_slope_var) # Roughtly get from sensitivity analysis 
  min_conductance ~ dgamma(1.5, 10) ## No clue. I looked at *Optimal stomatal behaviour around the world* which didn't have numbers for g_0 and argued that should just be minimun bound. I am doing a gamma with some varience. 
 precision ~ dgamma(1, 2) ## Guessing
}
"


data <- list(points_of_less_than_six = , 
            )

nchain = 3
init <- list()
for(i in 1:nchain){
  init[[i]] <- list(m = 0.5, D_0 = 0.016, min_conductance = 0.001)
}


j.model   <- jags.model (file = textConnection(Stomtal_slope),
                             data = data,
                             inits = init,
                             n.chains = 3)

jags.out   <- coda.samples (model = j.model,
                            variable.names = c("m","min_conductance","D_0", "precision"),
                                n.iter = n.iter)
GBR <- gelman.plot(jags.out)
burnin <- GBR$last.iter[tail(which(apply(GBR$shrink[,,2]>1.05,1,any)),1)+1]
if(is.na(burnin)){
  warning("GBR !< 1.05. Model may have failed to converge")
  jags.burn <- jags.out
  did_it_converge <- "convergence_failed_GBR_test" 
}else{
  did_it_converge <- "convergence_passed_GBR_test"
  jags.burn <- window(jags.out,start=burnin, extend = FALSE)
}
  date_stamp <- Sys.time()
  date_stamp <- format(date_stamp, "%Y%m%d")
  file_name <- paste("/Users/tess/Documents/work/SERDP_Project/Cogongrass_trait_sampling/Jags_output/", date_stamp, ".", "Stomatal_slope_of",".",leaf_name,".", did_it_converge, ".","JAGS_run.Rdata", sep = "")
  print(did_it_converge)
  print(effectiveSize(jags.burn))
  save(jags.burn, file = file_name )
  #return(jags.burn)
}

### Testing function
#temp_data <- dplyr::filter(full_curve, Name == "tess-feild-3")
#run_stomatal_slop_fit(temp_data = temp_data, leaf_name = "tess-feild-3", n.iter = 6000 )
#effectiveSize(jags.burn)

## Loop over each file (corresponding to each leaf)
leaves <- unique(full_curve$Name)
leaves <- leaves[!is.na(leaves)]

for ( i in seq_along(leaves)){
  temp_data <- dplyr::filter(full_curve, Name == leaves[i])
  run_stomatal_slop_fit(temp_data = temp_data, leaf_name = leaves[i], n.iter = 6000 )
 
}

```
